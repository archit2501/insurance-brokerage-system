CREATE TABLE IF NOT EXISTS commission_structures (id INTEGER PRIMARY KEY AUTOINCREMENT, insurer_id INTEGER NOT NULL REFERENCES insurers(id), lob_id INTEGER NOT NULL REFERENCES lobs(id), policy_type TEXT, commission_type TEXT NOT NULL DEFAULT 'percentage', rate REAL NOT NULL, min_amount REAL DEFAULT 0, max_amount REAL, effective_date TEXT NOT NULL, expiry_date TEXT, status TEXT NOT NULL DEFAULT 'active', notes TEXT, created_by INTEGER REFERENCES users(id), created_at TEXT NOT NULL, updated_at TEXT NOT NULL);
CREATE INDEX IF NOT EXISTS commission_structure_idx ON commission_structures(insurer_id, lob_id, policy_type, effective_date);
CREATE TABLE IF NOT EXISTS commissions (id INTEGER PRIMARY KEY AUTOINCREMENT, policy_id INTEGER REFERENCES policies(id), note_id INTEGER REFERENCES notes(id), agent_id INTEGER REFERENCES agents(id), structure_id INTEGER REFERENCES commission_structures(id), commission_type TEXT NOT NULL, rate REAL NOT NULL, base_amount REAL NOT NULL, commission_amount REAL NOT NULL, status TEXT NOT NULL DEFAULT 'pending', statement_id INTEGER, paid_date TEXT, notes TEXT, created_at TEXT NOT NULL, updated_at TEXT NOT NULL);
CREATE INDEX IF NOT EXISTS commission_agent_idx ON commissions(agent_id, status);
CREATE INDEX IF NOT EXISTS commission_policy_idx ON commissions(policy_id);
CREATE TABLE IF NOT EXISTS commission_statements (id INTEGER PRIMARY KEY AUTOINCREMENT, statement_number TEXT NOT NULL UNIQUE, agent_id INTEGER NOT NULL REFERENCES agents(id), period_start TEXT NOT NULL, period_end TEXT NOT NULL, total_commission REAL NOT NULL, status TEXT NOT NULL DEFAULT 'draft', issued_date TEXT, paid_date TEXT, payment_reference TEXT, notes TEXT, created_by INTEGER REFERENCES users(id), created_at TEXT NOT NULL, updated_at TEXT NOT NULL);
CREATE INDEX IF NOT EXISTS statement_agent_idx ON commission_statements(agent_id, period_start);
